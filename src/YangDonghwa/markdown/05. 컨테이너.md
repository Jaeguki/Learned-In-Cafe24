# 3. 커넥터
### 작성일
2019.05.10.

## 컨테이너란?
- 서블릿 요청을 처리하고 웹 클라이언트에 보낼 응답 객체를 만들어 주는 컴포넌트
- 인터페이스: `org.apache.catalina.Container`
- 종류: Engine, Host, Context, Wrapper


## Container 인터페이스
카탈리나의 컨테이너는 각기 다른 개념적 개념에 따라 네 종류의 컨테이너가 존재한다.

컨테이너 | 개념
--- | ---
Engine | 카탈리나 서블릿 엔진 전체를 나타낸다.
Host | 다양한 컨텍스트에 따른 가상 호스트를 나타낸다.
Context | 웹 애플리케이션을 나타내며, 둘 이상의 래퍼를 가진다.
Wrapper | 각각의 서블릿을 나타낸다.

위의 각각의 개념적인 단계는 `org.apache.catalina` 패키지의 `Engine, Host, Context, Wrapper` 인터페이스로 표현된다. 이 인터페이스는 모두 `Container` 인터페이스를 확장한다.

제대로 작동하는 카탈리나를 만들 때 네 종류의 컨테이너가 모두 필요하지는 않고, 각 컨테이너에는 하위 단계의 컨테이너가 없을 수도 있고 반대로 하위 컨테이너가 많이 있을 수도 있다.

Container 인터페이스의 메소드 | 기능
--- | ---
addChild | 하위 컨테이너 추가
removeChild | 하위 컨테이너 제거
findChild<br>findChildren | 각각의 하위 컨테이너나 하위 컨테이너의 집합을 찾을 수 있도록 제공하는 메소드

컨테이너는 Loader, Logger, Manager, Realm, Resources와 같은 다양한 지원 컴포넌트를 가질 수 있으며, Container 인터페이스는 자신이 포함하고 있는 컴포넌트에 관한 get 메소드와 set 메소드를 제공한다.

Container 인터페이스는 톰캣 관리자가 설정 파일(server.xml)을 편집함으로써 컨테이너의 동작 방식을 배치(deployment) 시에 결정할 수 있게 설계되었다. 이는 파이프라인과 한 세트의 밸브를 도입함으로써 가능해졌다.


## 파이프라인 태스크
파이프라인은 컨테이너가 호출할 태스크들을 포함하며 하나의 특정한 태스크는 밸브 하나로 포함된다. 컨테이너의 파이프라인에는 하나의 기본 밸브(Basic Valve)가 존재하지만 원하는 밸브를 얼마든지 추가할 수 있다. 밸브 수는 기본 밸브를 제외하고 추가한 밸브의 수로 정의되며, 밸브는 톰캣의 설정 파일(server.xml)을 편집함으로써 동적으로 추가할 수 있다.

밸브는 전달받은 요청/응답 객체를 조작할 수 있다. 하나의 밸브가 처리 작업을 끝내면 파이프라인에서의 다음 밸브를 호출하게 된다. 기본 밸브는 항상 마지막에 호출된다.

하나의 컨테이너는 하나의 파이프라인을 가질 수 있다. 컨테이너의 invoke 메소드가 호출되면 컨테이너는 파이프라인으로 처리권을 넘기며, 파이프라인은 첫 번째 밸브를 호출한다. 첫 번째 밸브에서의 처리가 완료되면 다음 밸브가 호출되며, 파이프라인에 더 이상의 밸브가 없을 때까지 호출이 진행된다.

### Pipeline 인터페이스

메소드 | 기능
--- | ---
invoke | 컨테이너가 파이프라인 내의 모든 밸브를 호출할 때 처음 호출하는 메소드
addValve | 새로운 밸브 추가
removeValve | 기존 밸브 제거
setBasic | 기본 밸브(Basic Valve) 할당
getBasic | 기본 밸브 얻어오기

- 가장 마지막에 호출되는 기본 밸브는 요청 객체와 그에 대응하는 응답 객체를 처리하는 책임을 가진다.

### Valve 인터페이스
밸브는 요청의 처리에 대한 책임이 있는 컴포넌트이며, Valve 인터페이스는 하나의 밸브를 나타낸다.

메소드 | 기능
--- | ---
invoke | 전달받은 요청/응답 객체 조작
getInfo | Valve를 구현한 객체에 관한 정보 반환

### ValveContext 인터페이스

메소드 | 기능
--- | ---
invokeNext | 다음 밸브 invoke
getInfo | ValveContext를 구현한 객체 정보를 반환

### Contained 인터페이스
밸브 클래스는 선택적으로 `org.apache.catalina.Contained` 인터페이스를 구현할 수도 있다. 이 인터페이스는 구현 클래스가 최대한 하나의 컨테이너와 연결돼있다는 것을 나타낸다.


## Wrapper 인터페이스
래퍼란 개별적인 하나의 서블릿을 대변하는 컨테이너이다. Wrapper의 구현 클래스는 각각의 서블릿의 생명주기를 책임져야 한다(서블릿의 init, service, destroy 메소드 호출 등). 래퍼는 가장 하위 단계의 컨테이너이므로 하위 컨테이너를 추가할 수 없다.

메소드 | 기능
--- | ---
allocate | 초기 서블릿 인스턴스를 래퍼에 할당한다. 또한, 서블릿이 `javax.servlet.SingleThreadModel` 인터페이스를 구현하는지를 반드시 고려해야 한다.
load | 래퍼가 대변하는 서블릿 인스턴스를 로드하고 초기화한다.


## Context 인터페이스
컨텍스트는 웹 애플리케이션을 나타내는 컨테이너이다. 컨테이너는 하위 컨테이너로서 보통 둘 이상의 래퍼를 갖고 있다.

## 컨테이너의 처리 순서
1. 하나의 컨테이너는 하나의 파이프라인을 갖는다. 컨테이너의 invoke 메소드는 파이프라인의 invoke 메소드를 호출한다.
2. 파이프라인의 invoke 메소드는 컨테이너에 추가된 모든 밸브를 호출한 다음 기본 밸브의 invoke 메소드를 호출한다.
3. 래퍼의 기본 밸브는 관련된 서블릿 클래스를 로드하고 요청에 대한 응답을 할 책임을 진다.
4. 컨텍스트의 기본 밸브는 요청을 처리하는 책임을 가지는 하위 컨테이너를 찾기 위해 맵퍼를 이용한다. 하위 컨테이너를 찾은 후에는 그 컨테이너의 invoke 메소드를 호출한다. 그 다음 다시 1번의 단계로 돌아간다.


## 요약
컨테이너는 커넥터 다음으로 중요한 모듈로, 로더, 로거, 매니저와 같은 여러 다른 모듈들을 사용한다. 컨테이너의 종류로는 엔진, 호스트, 컨텍스트, 래퍼가 있고 카탈리나는 이 4개의 컨테이너를 모두 필요로 하지는 않는다.


### 참고 문헌
- 톰캣 최종분석
